use std::fs;
use std::path::Path;

pub fn generate(_generated_dir: &Path, styles_dir: &Path) -> std::io::Result<()> {
    let output = styles_dir.join("canonrs.css");
    
    let mut content = String::from(
"/* ðŸ”’ AUTO-GENERATED - DO NOT EDIT */
/* Generated by tokens-engine - CanonRS Cascata */

/* 1. PRIMITIVES */
@import \"./.generated/primitives.css\";

/* 2. FOUNDATION */
@import \"./.generated/core.css\";

/* 3. FAMILIES */
");
    
    let families = [
        "family-a-overlay", "family-b-selection", "family-c-forms",
        "family-d-navigation", "family-e-feedback", "family-f-data",
        "family-g-composite", "family-h-layout", "family-i-animation",
        "family-s-state", "family-z-layers",
    ];
    
    for family in &families {
        content.push_str(&format!("@import \"./.generated/{}.css\";\n", family));
    }
    
    content.push_str("\n/* 4. SEMANTIC */\n@import \"./.generated/semantic.css\";\n");
    content.push_str("\n/* 5. THEMES */\n@import \"./.generated/themes.css\";\n");
    content.push_str("\n/* 6. ROOT */\n@import \"./.generated/root.css\";\n");
    
    content.push_str("\n/* 7. VARIANTS */\n");
    let variants_dir = styles_dir.join("variants");
    if variants_dir.exists() {
        for entry in fs::read_dir(variants_dir)? {
            let entry = entry?;
            if let Some(name) = entry.file_name().to_str() {
                if name.ends_with(".css") {
                    content.push_str(&format!("@import \"./variants/{}\";\n", name));
                }
            }
        }
    }
    
    for (section, dir_name) in [("8. UI COMPONENTS", "ui"), ("9. BLOCKS", "blocks"), ("10. LAYOUTS", "layouts")] {
        content.push_str(&format!("\n/* {} */\n", section));
        let dir = styles_dir.join(dir_name);
        if dir.exists() {
            let mut files: Vec<_> = fs::read_dir(dir)?.filter_map(|e| e.ok()).collect();
            files.sort_by_key(|e| e.file_name());
            for entry in files {
                if let Some(name) = entry.file_name().to_str() {
                    if name.ends_with(".css") {
                        content.push_str(&format!("@import \"./{}/{}\";\n", dir_name, name));
                    }
                }
            }
        }
    }
    
    content.push_str("\n/* 11. GLOBALS (FINAL) */\n@import \"./tokens/base/globals.css\";\n");
    
    fs::write(&output, content)?;
    println!("  âœ“ canonrs.css");
    Ok(())
}
