use std::fs;
use std::path::Path;

pub fn generate(_generated_dir: &Path, styles_dir: &Path) -> std::io::Result<()> {
    let output = styles_dir.join("canonrs.css");

    let mut content = String::from(
"/* ðŸ”’ AUTO-GENERATED - DO NOT EDIT */
/* Generated by tokens-engine - CanonRS Cascata */

/* 1. PRIMITIVES */
@import \"./.generated/primitives.css\";

/* 2. FOUNDATION */
@import \"./.generated/core.css\";

/* 3. FAMILIES */
");

    let families = [
        "family-a-overlay", "family-b-selection", "family-c-forms",
        "family-d-navigation", "family-e-feedback", "family-f-data",
        "family-g-composite", "family-h-layout", "family-i-animation",
        "family-s-state", "family-z-layers",
    ];

    for family in &families {
        content.push_str(&format!("@import \"./.generated/{}.css\";\n", family));
    }

    content.push_str("\n/* 4. SEMANTIC */\n@import \"./.generated/semantic.css\";\n");
    content.push_str("\n/* 5. THEMES */\n@import \"./.generated/themes.css\";\n");
    content.push_str("\n/* 6. ROOT */\n@import \"./.generated/root.css\";\n");

    content.push_str("\n/* 7. VARIANTS */\n");
    let variants_dir = styles_dir.join("variants");
    if variants_dir.exists() {
        for entry in fs::read_dir(variants_dir)? {
            let entry = entry?;
            if let Some(name) = entry.file_name().to_str() {
                if name.ends_with(".css") {
                    content.push_str(&format!("@import \"./variants/{}\";\n", name));
                }
            }
        }
    }

    // Import aggregated UI, Blocks, Layouts (not individual files)
    content.push_str("\n/* 8. UI COMPONENTS */\n@import \"./ui/ui.css\";\n");
    content.push_str("\n/* 9. BLOCKS */\n@import \"./blocks/blocks.css\";\n");
    content.push_str("\n/* 10. LAYOUTS */\n@import \"./layouts/layouts.css\";\n");

    content.push_str("\n/* 11. GLOBALS (FINAL) */\n@import \"./tokens/base/globals.css\";\n");

    fs::write(&output, content)?;
    println!("  âœ“ canonrs.css");
    Ok(())
}
